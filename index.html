<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PianoSynth</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        #synth-container {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
        }

        #controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control label {
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            background: #4a4a4a;
            outline: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #00ff9d;
            cursor: pointer;
            box-shadow: -410px 0 0 400px #00ff9d;
        }

        select {
            width: 100%;
            padding: 5px;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: none;
            border-radius: 5px;
        }

        #piano {
            display: flex;
            background-color: #333;
            padding: 10px;
            border-radius: 10px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .key {
            width: 30px;
            height: 120px;
            background-color: white;
            border: 1px solid #000;
            margin: 0 1px;
            cursor: pointer;
        }

        .key.black {
            width: 20px;
            height: 80px;
            background-color: black;
            margin: 0 -10px;
            z-index: 1;
            position: relative;
        }

        .key.active {
            background-color: #00ff9d;
        }

        #visualizer {
            width: 100%;
            height: 100px;
            border: 1px solid #4a4a4a;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="synth-container">
        <h1>Advanced PianoSynth</h1>
        <div id="controls">
            <div class="control">
                <label for="waveform">Waveform</label>
                <select id="waveform">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div class="control">
                <label for="attack">Attack</label>
                <input type="range" id="attack" min="0" max="2" step="0.01" value="0.05">
            </div>
            <div class="control">
                <label for="decay">Decay</label>
                <input type="range" id="decay" min="0" max="2" step="0.01" value="0.1">
            </div>
            <div class="control">
                <label for="sustain">Sustain</label>
                <input type="range" id="sustain" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control">
                <label for="release">Release</label>
                <input type="range" id="release" min="0" max="5" step="0.01" value="0.5">
            </div>
            <div class="control">
                <label for="filterCutoff">Filter Cutoff</label>
                <input type="range" id="filterCutoff" min="20" max="20000" step="1" value="20000">
            </div>
            <div class="control">
                <label for="filterResonance">Filter Resonance</label>
                <input type="range" id="filterResonance" min="0" max="20" step="0.1" value="0">
            </div>
            <div class="control">
                <label for="lfoRate">LFO Rate</label>
                <input type="range" id="lfoRate" min="0" max="20" step="0.1" value="0">
            </div>
        </div>
        <div id="piano"></div>
        <canvas id="visualizer"></canvas>
    </div>
    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const masterGainNode = audioContext.createGain();
        masterGainNode.connect(audioContext.destination);

        const controls = {
            waveform: document.getElementById('waveform'),
            attack: document.getElementById('attack'),
            decay: document.getElementById('decay'),
            sustain: document.getElementById('sustain'),
            release: document.getElementById('release'),
            filterCutoff: document.getElementById('filterCutoff'),
            filterResonance: document.getElementById('filterResonance'),
            lfoRate: document.getElementById('lfoRate')
        };

        const visualizer = document.getElementById('visualizer');
        const visualizerContext = visualizer.getContext('2d');

        let activeVoices = {};
        let activeNotes = new Set();

        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#'];

        const keyboardMap = {
            'q': 'C4', 'w': 'D4', 'e': 'E4', 'r': 'F4', 't': 'G4', 'y': 'A4', 'u': 'B4', 'ı': 'C5', 'o': 'D5', 'p': 'E5', 'ğ': 'F5', 'ü': 'G5',
            'a': 'C#4', 's': 'D#4', 'f': 'F#4', 'g': 'G#4', 'h': 'A#4', 'j': 'C#5', 'k': 'D#5', 'l': 'F#5', 'ş': 'G#5', 'i': 'A#5',
            'z': 'C3', 'x': 'D3', 'c': 'E3', 'v': 'F3', 'b': 'G3', 'n': 'A3', 'm': 'B3', 'ö': 'C4', 'ç': 'D4', '.': 'E4'
        };

        function createPiano() {
            const piano = document.getElementById('piano');
            piano.innerHTML = ''; // Clear existing keys
            for (let octave = 2; octave < 6; octave++) {
                whiteNotes.forEach(note => {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.dataset.note = note + octave;
                    piano.appendChild(key);
                });
            }

            const whiteKeys = piano.querySelectorAll('.key');
            let blackKeyIndex = 0;
            whiteKeys.forEach((whiteKey, index) => {
                if (index % 7 !== 2 && index % 7 !== 6) {
                    const blackKey = document.createElement('div');
                    blackKey.className = 'key black';
                    blackKey.dataset.note = blackNotes[blackKeyIndex % 5] + (Math.floor(index / 7) + 2);
                    whiteKey.parentNode.insertBefore(blackKey, whiteKey.nextSibling);
                    blackKeyIndex++;
                }
            });
        }

        function playNote(note) {
            const now = audioContext.currentTime;
            const frequency = noteToFreq(note);

            const oscillator = audioContext.createOscillator();
            oscillator.type = controls.waveform.value;
            oscillator.frequency.setValueAtTime(frequency, now);

            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, now);

            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(controls.filterCutoff.value, now);
            filter.Q.setValueAtTime(controls.filterResonance.value, now);

            oscillator.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(masterGainNode);

            const attackTime = parseFloat(controls.attack.value);
            const decayTime = parseFloat(controls.decay.value);
            const sustainLevel = parseFloat(controls.sustain.value);

            // Adjust the peak level based on the number of active notes
            const peakLevel = 0.66 / Math.max(1, Math.sqrt(activeNotes.size));
            const sustainedLevel = sustainLevel * peakLevel;

            gainNode.gain.linearRampToValueAtTime(peakLevel, now + attackTime);
            gainNode.gain.linearRampToValueAtTime(sustainedLevel, now + attackTime + decayTime);

            oscillator.start(now);

            // Apply LFO
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();
            lfo.frequency.setValueAtTime(parseFloat(controls.lfoRate.value), now);
            lfoGain.gain.setValueAtTime(50, now); // LFO depth
            lfo.connect(lfoGain);
            lfoGain.connect(filter.frequency);
            lfo.start(now);

            const voice = { oscillator, gainNode, filter, lfo, lfoGain };

            if (activeVoices[note]) {
                releaseVoice(activeVoices[note]);
            }

            activeVoices[note] = voice;
            activeNotes.add(note);

            const keyElement = document.querySelector(`.key[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
            }
        }

        function releaseVoice(voice) {
            const now = audioContext.currentTime;
            const releaseTime = parseFloat(controls.release.value);

            voice.gainNode.gain.cancelScheduledValues(now);
            voice.gainNode.gain.setValueAtTime(voice.gainNode.gain.value, now);
            voice.gainNode.gain.linearRampToValueAtTime(0, now + releaseTime);

            setTimeout(() => {
                voice.oscillator.stop();
                voice.oscillator.disconnect();
                voice.gainNode.disconnect();
                voice.filter.disconnect();
                voice.lfo.stop();
                voice.lfo.disconnect();
                voice.lfoGain.disconnect();
            }, releaseTime * 1000);
        }

        function stopNote(note) {
            if (activeVoices[note]) {
                releaseVoice(activeVoices[note]);
                delete activeVoices[note];
                activeNotes.delete(note);

                const keyElement = document.querySelector(`.key[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.remove('active');
                }
            }
        }

        function noteToFreq(note) {
            const noteIndex = notes.indexOf(note.slice(0, -1));
            const octave = parseInt(note.slice(-1));
            return 440 * Math.pow(2, (noteIndex - 9) / 12 + (octave - 4));
        }

        function drawVisualizer() {
            const width = visualizer.offsetWidth;
            const height = visualizer.offsetHeight;
            visualizer.width = width;
            visualizer.height = height;

            const analyser = audioContext.createAnalyser();
            masterGainNode.connect(analyser);

            analyser.fftSize = 2048;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            visualizerContext.clearRect(0, 0, width, height);

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteTimeDomainData(dataArray);

                visualizerContext.fillStyle = 'rgb(26, 26, 26)';
                visualizerContext.fillRect(0, 0, width, height);

                visualizerContext.lineWidth = 2;
                visualizerContext.strokeStyle = '#00ff9d';
                visualizerContext.beginPath();

                const sliceWidth = width * 1.0 / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * height / 2;

                    if (i === 0) {
                        visualizerContext.moveTo(x, y);
                    } else {
                        visualizerContext.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                visualizerContext.lineTo(width, height / 2);
                visualizerContext.stroke();
            }

            draw();
        }

        function initializeSynth() {
            createPiano();
            drawVisualizer();

            const keys = document.querySelectorAll('.key');
            keys.forEach(key => {
                key.addEventListener('mousedown', () => {
                    const note = key.dataset.note;
                    playNote(note);
                });
                key.addEventListener('mouseup', () => stopNote(key.dataset.note));
                key.addEventListener('mouseleave', () => stopNote(key.dataset.note));
            });
        }

        document.addEventListener('DOMContentLoaded', initializeSynth);

        document.addEventListener('keydown', (event) => {
            const note = keyboardMap[event.key.toLowerCase()];
            if (note && !event.repeat) {
                playNote(note);
            }
        });

        document.addEventListener('keyup', (event) => {
            const note = keyboardMap[event.key.toLowerCase()];
            if (note) {
                stopNote(note);
            }
        });

        window.addEventListener('blur', () => {
            activeNotes.forEach(stopNote);
        });

        window.addEventListener('resize', drawVisualizer);

        function stopAllNotes() {
            activeNotes.forEach(stopNote);
        }

        Object.values(controls).forEach(control => {
            control.addEventListener('change', updateSynthParams);
        });

        function updateSynthParams() {
            Object.values(activeVoices).forEach(voice => {
                voice.filter.frequency.setValueAtTime(controls.filterCutoff.value, audioContext.currentTime);
                voice.filter.Q.setValueAtTime(controls.filterResonance.value, audioContext.currentTime);
                voice.lfo.frequency.setValueAtTime(parseFloat(controls.lfoRate.value), audioContext.currentTime);
            });
        }

        // Initialize audio context on user interaction
        document.addEventListener('click', function initAudio() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            document.removeEventListener('click', initAudio);
        });
    </script>
</body>

</html>